# Generated Python ANSI Art
ansi_art_lines = [
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m[38;2;43;111;199m‚ñà[0m[38;2;45;110;199m‚ñà[0m[38;2;47;110;199m‚ñà[0m[38;2;49;109;198m‚ñà[0m[38;2;51;108;198m‚ñà[0m[38;2;53;108;198m‚ñà[0m[38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m    [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m        [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m  [38;2;162;71;189m‚ñà[0m[38;2;164;70;189m‚ñà[0m[38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m      [38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m[38;2;186;63;188m‚ñà[0m[38;2;188;63;188m‚ñà[0m",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m[38;2;43;111;199m‚ñà[0m[38;2;45;110;199m‚ñà[0m[38;2;47;110;199m‚ñà[0m[38;2;49;109;198m‚ñà[0m[38;2;51;108;198m‚ñà[0m[38;2;53;108;198m‚ñà[0m[38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m        [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m  [38;2;162;71;189m‚ñà[0m[38;2;164;70;189m‚ñà[0m[38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m      [38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m[38;2;186;63;188m‚ñà[0m[38;2;188;63;188m‚ñà[0m",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m      [38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m[38;2;105;90;194m‚ñà[0m[38;2;107;90;194m‚ñà[0m      [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m  [38;2;162;71;189m‚ñà[0m[38;2;164;70;189m‚ñà[0m[38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m[38;2;170;68;189m‚ñà[0m[38;2;172;68;189m‚ñà[0m  [38;2;178;66;188m‚ñà[0m[38;2;180;65;188m‚ñà[0m[38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m[38;2;186;63;188m‚ñà[0m[38;2;188;63;188m‚ñà[0m",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m      [38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m[38;2;105;90;194m‚ñà[0m[38;2;107;90;194m‚ñà[0m[38;2;109;89;194m‚ñà[0m[38;2;111;88;194m‚ñà[0m    [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m    [38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m[38;2;170;68;189m‚ñà[0m[38;2;172;68;189m‚ñà[0m[38;2;174;67;189m‚ñà[0m[38;2;176;66;188m‚ñà[0m[38;2;178;66;188m‚ñà[0m[38;2;180;65;188m‚ñà[0m[38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m  ",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m[38;2;43;111;199m‚ñà[0m[38;2;45;110;199m‚ñà[0m[38;2;47;110;199m‚ñà[0m[38;2;49;109;198m‚ñà[0m[38;2;51;108;198m‚ñà[0m[38;2;53;108;198m‚ñà[0m[38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m[38;2;74;101;196m‚ñà[0m[38;2;76;100;196m‚ñà[0m[38;2;78;99;196m‚ñà[0m[38;2;80;99;196m‚ñà[0m[38;2;82;98;196m‚ñà[0m[38;2;84;97;196m‚ñà[0m[38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m[38;2;105;90;194m‚ñà[0m[38;2;107;90;194m‚ñà[0m[38;2;109;89;194m‚ñà[0m[38;2;111;88;194m‚ñà[0m[38;2;112;88;193m‚ñà[0m[38;2;114;87;193m‚ñà[0m  [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m      [38;2;170;68;189m‚ñà[0m[38;2;172;68;189m‚ñà[0m[38;2;174;67;189m‚ñà[0m[38;2;176;66;188m‚ñà[0m[38;2;178;66;188m‚ñà[0m[38;2;180;65;188m‚ñà[0m    ",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m[38;2;43;111;199m‚ñà[0m[38;2;45;110;199m‚ñà[0m[38;2;47;110;199m‚ñà[0m[38;2;49;109;198m‚ñà[0m[38;2;51;108;198m‚ñà[0m[38;2;53;108;198m‚ñà[0m[38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m    [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m[38;2;74;101;196m‚ñà[0m[38;2;76;100;196m‚ñà[0m[38;2;78;99;196m‚ñà[0m[38;2;80;99;196m‚ñà[0m[38;2;82;98;196m‚ñà[0m[38;2;84;97;196m‚ñà[0m[38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m  [38;2;109;89;194m‚ñà[0m[38;2;111;88;194m‚ñà[0m[38;2;112;88;193m‚ñà[0m[38;2;114;87;193m‚ñà[0m[38;2;116;86;193m‚ñà[0m[38;2;118;86;193m‚ñà[0m[38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m      [38;2;170;68;189m‚ñà[0m[38;2;172;68;189m‚ñà[0m[38;2;174;67;189m‚ñà[0m[38;2;176;66;188m‚ñà[0m[38;2;178;66;188m‚ñà[0m[38;2;180;65;188m‚ñà[0m    ",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m    [38;2;51;108;198m‚ñà[0m[38;2;53;108;198m‚ñà[0m[38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m    [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m    [38;2;112;88;193m‚ñà[0m[38;2;114;87;193m‚ñà[0m[38;2;116;86;193m‚ñà[0m[38;2;118;86;193m‚ñà[0m[38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m    [38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m[38;2;170;68;189m‚ñà[0m[38;2;172;68;189m‚ñà[0m[38;2;174;67;189m‚ñà[0m[38;2;176;66;188m‚ñà[0m[38;2;178;66;188m‚ñà[0m[38;2;180;65;188m‚ñà[0m[38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m  ",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m    [38;2;51;108;198m‚ñà[0m[38;2;53;108;198m‚ñà[0m[38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m      [38;2;116;86;193m‚ñà[0m[38;2;118;86;193m‚ñà[0m[38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m      [38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m  [38;2;162;71;189m‚ñà[0m[38;2;164;70;189m‚ñà[0m[38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m[38;2;170;68;189m‚ñà[0m[38;2;172;68;189m‚ñà[0m  [38;2;178;66;188m‚ñà[0m[38;2;180;65;188m‚ñà[0m[38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m[38;2;186;63;188m‚ñà[0m[38;2;188;63;188m‚ñà[0m",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m      [38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m        [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m  [38;2;132;81;192m‚ñà[0m[38;2;134;81;192m‚ñà[0m[38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m[38;2;139;79;191m‚ñà[0m[38;2;141;78;191m‚ñà[0m[38;2;143;77;191m‚ñà[0m[38;2;145;77;191m‚ñà[0m[38;2;147;76;191m‚ñà[0m[38;2;149;75;191m‚ñà[0m[38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m[38;2;155;73;190m‚ñà[0m[38;2;157;73;190m‚ñà[0m  [38;2;162;71;189m‚ñà[0m[38;2;164;70;189m‚ñà[0m[38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m      [38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m[38;2;186;63;188m‚ñà[0m[38;2;188;63;188m‚ñà[0m",
    "[38;2;36;114;200m‚ñà[0m[38;2;37;113;199m‚ñà[0m[38;2;39;112;199m‚ñà[0m[38;2;41;112;199m‚ñà[0m      [38;2;55;107;198m‚ñà[0m[38;2;57;106;198m‚ñà[0m[38;2;59;106;198m‚ñà[0m[38;2;61;105;198m‚ñà[0m  [38;2;66;103;197m‚ñà[0m[38;2;68;103;197m‚ñà[0m[38;2;70;102;197m‚ñà[0m[38;2;72;101;197m‚ñà[0m      [38;2;86;97;196m‚ñà[0m[38;2;87;96;195m‚ñà[0m[38;2;89;95;195m‚ñà[0m[38;2;91;95;195m‚ñà[0m  [38;2;97;93;195m‚ñà[0m[38;2;99;92;194m‚ñà[0m[38;2;101;92;194m‚ñà[0m[38;2;103;91;194m‚ñà[0m        [38;2;120;85;193m‚ñà[0m[38;2;122;84;193m‚ñà[0m[38;2;124;84;193m‚ñà[0m[38;2;126;83;192m‚ñà[0m    [38;2;136;80;192m‚ñà[0m[38;2;137;79;191m‚ñà[0m[38;2;139;79;191m‚ñà[0m[38;2;141;78;191m‚ñà[0m[38;2;143;77;191m‚ñà[0m[38;2;145;77;191m‚ñà[0m[38;2;147;76;191m‚ñà[0m[38;2;149;75;191m‚ñà[0m[38;2;151;75;190m‚ñà[0m[38;2;153;74;190m‚ñà[0m    [38;2;162;71;189m‚ñà[0m[38;2;164;70;189m‚ñà[0m[38;2;166;70;189m‚ñà[0m[38;2;168;69;189m‚ñà[0m      [38;2;182;64;188m‚ñà[0m[38;2;184;64;188m‚ñà[0m[38;2;186;63;188m‚ñà[0m[38;2;188;63;188m‚ñà[0m",
]

def display_ansi_art():
    for line in ansi_art_lines:
        print(line)

display_ansi_art()

#!/usr/bin/env python3
"""
SAP CVE Automation Tool - Versi√≥n Optimizada y Corregida
Mejoras en SploitScan y CVE_Prioritizer manteniendo funcionalidad original
"""

import pandas as pd
import re
import json
import subprocess
import os
import sys
import time
import glob
import shutil
from pathlib import Path
from datetime import datetime
from typing import Optional, List, Dict, Any, Tuple
from concurrent.futures import ThreadPoolExecutor, as_completed
from threading import Lock

import typer
from rich.console import Console
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn
import requests
from bs4 import BeautifulSoup
import logging

# ==================== CONFIGURACI√ìN ====================

console = Console()
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

app = typer.Typer(help="üîí SAP CVE Automation Tool - Optimizado")

# Par√°metros de procesamiento
BATCH_SIZE = 10
MAX_WORKERS = 3
DELAY_BETWEEN_REQUESTS = 2
DELAY_BETWEEN_BATCHES = 3
CHECKPOINT_INTERVAL = 20

# Thread safety
write_lock = Lock()
progress_lock = Lock()


# ==================== CLASE PRINCIPAL ====================

class SAPCVEAutomation:
    """Automatizaci√≥n de an√°lisis de CVEs SAP"""
    
    def __init__(self):
        self.months = {
            1: 'january', 2: 'february', 3: 'march', 4: 'april',
            5: 'may', 6: 'june', 7: 'july', 8: 'august',
            9: 'september', 10: 'october', 11: 'november', 12: 'december'
        }
        self.output_dir = Path(f"sap_cve_analysis_{datetime.now().strftime('%Y%m%d')}")
        self.output_dir.mkdir(exist_ok=True)
        
        # Estado
        self.checkpoint_file = self.output_dir / "checkpoint.json"
        self.processed_cves = set()
        self.failed_cves = []
        self.sploitscan_results = []
    
    # ==================== CHECKPOINT ====================
    
    def _load_checkpoint(self):
        """Carga progreso previo"""
        if self.checkpoint_file.exists():
            try:
                with open(self.checkpoint_file, 'r') as f:
                    data = json.load(f)
                    self.processed_cves = set(data.get('processed', []))
                    self.failed_cves = data.get('failed', [])
                    console.print(f"üìã Checkpoint: {len(self.processed_cves)} CVEs procesados")
            except Exception as e:
                console.print(f"‚ö†Ô∏è Error cargando checkpoint: {e}")
    
    def _save_checkpoint(self):
        """Guarda progreso actual"""
        try:
            with open(self.checkpoint_file, 'w') as f:
                json.dump({
                    'processed': list(self.processed_cves),
                    'failed': self.failed_cves,
                    'timestamp': datetime.now().isoformat()
                }, f, indent=2)
        except Exception as e:
            logger.error(f"Error guardando checkpoint: {e}")
    
    # ==================== EXTRACCI√ìN SAP ====================
    
    def extract_sap_data(self, year: int, month: int) -> pd.DataFrame:
        """Extrae datos de SAP Security Notes"""
        month_name = self.months.get(month, '')
        url = f"https://support.sap.com/en/my-support/knowledge-base/security-notes-news/{month_name}-{year}.html"
        
        console.print(f"üî° Extrayendo: {month_name.title()} {year}")
        console.print(f"üåê URL: {url}")
        
        resp = requests.get(url, timeout=30)
        resp.raise_for_status()
        soup = BeautifulSoup(resp.text, "lxml")
        
        tables = soup.find_all("table")
        console.print(f"üìä Tablas encontradas: {len(tables)}")
        
        # Extraer filas
        all_rows = []
        for tbl in tables:
            for tr in tbl.find_all("tr"):
                cells = [td.get_text(" ", strip=True) for td in tr.find_all(["td", "th"])]
                if cells:
                    all_rows.append(cells)
        
        # Filtrar filas v√°lidas
        note_pattern = re.compile(r'[23]\d{6,7}')
        cve_pattern = re.compile(r'CVE-\d{4}-\d{4,7}')
        valid_rows = [
            row for row in all_rows
            if any(note_pattern.search(cell) or cve_pattern.search(cell) for cell in row)
        ]
        
        df = pd.DataFrame(valid_rows)
        console.print(f"‚úÖ Filas v√°lidas: {len(df)}")
        return df
    
    def process_sap_data(self, df: pd.DataFrame) -> Tuple[pd.DataFrame, List[str]]:
        """Procesa datos SAP y extrae CVEs"""
        if df.empty:
            return pd.DataFrame(), []
        
        # Renombrar columnas
        col_names = [f"Col{i}" for i in range(df.shape[1])]
        df.columns = col_names
        
        # Extraer CVE-IDs
        df["cve_id"] = df.apply(
            lambda row: next(
                (m.group(0) for cell in row.astype(str) 
                 if (m := re.search(r'CVE-\d{4}-\d{4,7}', cell))),
                None
            ),
            axis=1
        )
        
        cves = df["cve_id"].dropna().unique().tolist()
        console.print(f"‚úÖ CVEs encontrados: {len(cves)}")
        
        return df, cves
    
    # ==================== SPLOITSCAN OPTIMIZADO ====================
    
    def _run_sploitscan_single(self, cve_id: str, config_file: str) -> Optional[Dict]:
        """
        Ejecuta SploitScan para un CVE individual
        Usa el m√©todo del script original que funciona
        """
        try:
            # Obtener lista de archivos ANTES de ejecutar
            files_before = set(glob.glob("*_export.json")) | set(glob.glob("*_and_*more_export.json"))
            
            # Comando igual al original
            cmd = [
                "sploitscan",
                cve_id,
                "-c", config_file,
                "-m", "cisa,epss,prio,references",
                "-d",
                "-e", "json"
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=90)
            
            if result.returncode != 0:
                logger.debug(f"SploitScan fall√≥ para {cve_id}")
                return None
            
            # Esperar escritura del archivo
            time.sleep(2)
            
            # Encontrar archivo nuevo
            files_after = set(glob.glob("*_export.json")) | set(glob.glob("*_and_*more_export.json"))
            new_files = files_after - files_before
            
            if not new_files:
                # Fallback: archivo m√°s reciente
                all_files = list(files_after)
                if not all_files:
                    return None
                generated_file = max(all_files, key=os.path.getmtime)
            else:
                generated_file = new_files.pop()
            
            # Leer y eliminar
            with open(generated_file, 'r') as f:
                data = json.load(f)
            os.remove(generated_file)
            
            # Extraer primer resultado
            if isinstance(data, list) and len(data) > 0:
                return data[0]
            return data if isinstance(data, dict) else None
            
        except subprocess.TimeoutExpired:
            logger.warning(f"Timeout: {cve_id}")
            return None
        except Exception as e:
            logger.error(f"Error {cve_id}: {e}")
            return None
    
    def _process_cve_batch(self, cve_id: str, config_file: str) -> Dict[str, Any]:
        """Procesa un CVE con metadata"""
        try:
            result = self._run_sploitscan_single(cve_id, config_file)
            
            if result:
                with progress_lock:
                    self.processed_cves.add(cve_id)
                return {'success': True, 'cve_id': cve_id, 'data': result}
            else:
                with progress_lock:
                    self.failed_cves.append(cve_id)
                return {'success': False, 'cve_id': cve_id, 'data': None}
                
        except Exception as e:
            logger.error(f"Batch error {cve_id}: {e}")
            with progress_lock:
                if cve_id not in self.failed_cves:
                    self.failed_cves.append(cve_id)
            return {'success': False, 'cve_id': cve_id, 'data': None}
    
    def run_sploitscan(
        self,
        cve_list: List[str],
        tool_path: str = ".",
        batch_size: int = BATCH_SIZE,
        max_workers: int = MAX_WORKERS
    ) -> str:
        """
        Ejecuta SploitScan optimizado con:
        - Procesamiento paralelo
        - Checkpoint
        - Rate limiting
        """
        console.print(f"üîç SploitScan Optimizado")
        console.print(f"üìä CVEs totales: {len(cve_list)}")
        console.print(f"‚öôÔ∏è Config: {batch_size} CVEs/lote, {max_workers} workers")
        
        original_dir = os.getcwd()
        self.sploitscan_results = []
        
        # Cargar checkpoint
        self._load_checkpoint()
        
        # Filtrar procesados
        pending_cves = [cve for cve in cve_list if cve not in self.processed_cves]
        
        if not pending_cves:
            console.print("‚úÖ Todos procesados previamente")
            return self._consolidate_results()
        
        console.print(f"üìã Pendientes: {len(pending_cves)}/{len(cve_list)}")
        
        try:
            # Cambiar directorio si es necesario
            if tool_path != "." and os.path.exists(tool_path):
                os.chdir(tool_path)
            
            # Buscar archivo de configuraci√≥n
            config_file = self._find_config_file()
            console.print(f"üîß Config: {config_file}")
            
            total_batches = (len(pending_cves) + batch_size - 1) // batch_size
            
            # Procesar con barra de progreso
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                BarColumn(),
                TaskProgressColumn(),
                console=console
            ) as progress:
                
                task = progress.add_task("Procesando CVEs...", total=len(pending_cves))
                
                for i in range(0, len(pending_cves), batch_size):
                    batch = pending_cves[i:i + batch_size]
                    batch_num = (i // batch_size) + 1
                    
                    progress.update(task, description=f"Lote {batch_num}/{total_batches}")
                    
                    # Procesar lote en paralelo
                    with ThreadPoolExecutor(max_workers=max_workers) as executor:
                        futures = {
                            executor.submit(self._process_cve_batch, cve, config_file): cve
                            for cve in batch
                        }
                        
                        for future in as_completed(futures):
                            try:
                                result = future.result()
                                if result['success'] and result['data']:
                                    self.sploitscan_results.append(result['data'])
                                progress.advance(task)
                                time.sleep(max(0.5, DELAY_BETWEEN_REQUESTS / max_workers))
                            except Exception as e:
                                logger.error(f"Future error: {e}")
                                progress.advance(task)
                    
                    # Checkpoint peri√≥dico
                    if len(self.processed_cves) % CHECKPOINT_INTERVAL == 0:
                        self._save_checkpoint()
                    
                    # Delay entre lotes
                    if i + batch_size < len(pending_cves):
                        time.sleep(DELAY_BETWEEN_BATCHES)
            
            # Checkpoint final
            self._save_checkpoint()
            
            # Consolidar y reportar
            return self._consolidate_and_report()
            
        except FileNotFoundError:
            console.print("‚ùå 'sploitscan' no encontrado")
            return ""
        except Exception as e:
            console.print(f"‚ùå Error general: {e}")
            logger.error(f"Error en run_sploitscan: {e}", exc_info=True)
            return ""
        finally:
            os.chdir(original_dir)
    
    def _find_config_file(self) -> str:
        """Busca archivo de configuraci√≥n en ubicaciones comunes"""
        paths = [".streamlit/config.json", "config.json", "../config.json"]
        for path in paths:
            if os.path.exists(path):
                return path
        return "config.json"  # Default
    
    def _consolidate_results(self) -> str:
        """Consolida resultados existentes"""
        if not self.sploitscan_results:
            return ""
        
        filename = f"sploitscan_consolidated_{datetime.now().strftime('%Y%m%d%H%M%S')}.json"
        try:
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(self.sploitscan_results, f, indent=4, ensure_ascii=False)
            return filename
        except Exception as e:
            logger.error(f"Error consolidando: {e}")
            return ""
    
    def _consolidate_and_report(self) -> str:
        """Consolida resultados y muestra reporte"""
        if not self.sploitscan_results:
            console.print("‚ùå Sin resultados")
            return ""
        
        filename = self._consolidate_results()
        if not filename:
            return ""
        
        # Reporte
        console.print(f"\nüìä Resumen SploitScan:")
        console.print(f"   ‚úÖ Exitosos: {len(self.sploitscan_results)}")
        console.print(f"   ‚ùå Fallidos: {len(self.failed_cves)}")
        console.print(f"   üìÅ Archivo: {filename}")
        
        if self.failed_cves:
            console.print(f"\n‚ö†Ô∏è CVEs fallidos ({len(self.failed_cves)}):")
            for cve in self.failed_cves[:10]:
                console.print(f"      ‚Ä¢ {cve}")
            if len(self.failed_cves) > 10:
                console.print(f"      ... y {len(self.failed_cves) - 10} m√°s")
        
        return filename
    
    # ==================== CVE_PRIORITIZER OPTIMIZADO ====================
    
    def run_cve_prioritizer(
        self,
        cve_list: List[str],
        output_file: str,
        tool_path: str = ".",
        batch_size: int = 50
    ) -> bool:
        """Ejecuta CVE_Prioritizer en lotes"""
        console.print(f"üìä CVE_Prioritizer Optimizado")
        console.print(f"üìã CVEs: {len(cve_list)}")
        
        original_dir = os.getcwd()
        all_results = []
        
        try:
            if tool_path != "." and os.path.exists(tool_path):
                os.chdir(tool_path)
            
            total_batches = (len(cve_list) + batch_size - 1) // batch_size
            
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                BarColumn(),
                TaskProgressColumn(),
                console=console
            ) as progress:
                
                task = progress.add_task("Priorizando CVEs...", total=total_batches)
                
                for i in range(0, len(cve_list), batch_size):
                    batch = cve_list[i:i + batch_size]
                    batch_num = (i // batch_size) + 1
                    
                    progress.update(task, description=f"Lote {batch_num}/{total_batches}")
                    
                    # Procesar lote
                    temp_file = f"temp_prioritizer_{batch_num}.csv"
                    if self._run_prioritizer_batch(batch, temp_file):
                        try:
                            df = pd.read_csv(temp_file)
                            all_results.append(df)
                            os.remove(temp_file)
                        except Exception as e:
                            logger.error(f"Error leyendo lote {batch_num}: {e}")
                    
                    progress.advance(task)
                    time.sleep(DELAY_BETWEEN_BATCHES)
            
            # Combinar resultados
            if all_results:
                combined_df = pd.concat(all_results, ignore_index=True)
                combined_df.drop_duplicates(subset=['cve_id'], inplace=True)
                combined_df.to_csv(output_file, index=False)
                
                console.print(f"‚úÖ CVE_Prioritizer: {output_file}")
                console.print(f"   üìä CVEs procesados: {len(combined_df)}")
                return True
            else:
                console.print("‚ùå Sin resultados")
                return False
                
        except FileNotFoundError:
            console.print("‚ùå 'cve_prioritizer' no encontrado")
            return False
        except Exception as e:
            console.print(f"‚ùå Error: {e}")
            logger.error(f"Error en CVE_Prioritizer: {e}", exc_info=True)
            return False
        finally:
            os.chdir(original_dir)
    
    def _run_prioritizer_batch(self, cve_batch: List[str], output_file: str) -> bool:
        """Ejecuta CVE_Prioritizer para un lote"""
        try:
            cve_string = ",".join(cve_batch)
            cmd = [
                "cve_prioritizer",
                "-l", cve_string,
                "-vck", "-vc", "-v",
                "-o", output_file
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
            return result.returncode == 0 and os.path.exists(output_file)
            
        except subprocess.TimeoutExpired:
            logger.warning("Timeout en lote CVE_Prioritizer")
            return False
        except Exception as e:
            logger.error(f"Error en lote: {e}")
            return False
    
    # ==================== PROCESAMIENTO DE RESULTADOS ====================
    
    def dataframeSplotscan(self, file_json: str) -> pd.DataFrame:
        """Procesa JSON de SploitScan - EXACTO AL ORIGINAL"""
        try:
            if not os.path.exists(file_json):
                console.print(f"‚ùå Archivo no encontrado: {file_json}")
                return pd.DataFrame()
            
            console.print("üìÑ Procesando resultados SploitScan...")
            
            dict_list = []
            sap_sp = pd.read_json(file_json, typ='series')
            
            for i in sap_sp:
                # CWE
                if 'problemTypes' in i['CVE Data']['containers']['cna'].keys():
                    if 'cweId' in i['CVE Data']['containers']['cna']['problemTypes'][0]['descriptions'][0].keys():
                        cweId = i['CVE Data']['containers']['cna']['problemTypes'][0]['descriptions'][0]['cweId']
                    else:
                        cweId = i['CVE Data']['containers']['cna']['problemTypes'][0]['descriptions'][0]['description']
                else:
                    cweId = None
                
                # EPSS
                if len(i['EPSS Data']['data']) == 1:
                    epss_l = i['EPSS Data']['data'][0]['epss']
                    percentile = i['EPSS Data']['data'][0]['percentile']
                else:
                    epss_l = None
                    percentile = None
                
                # Date Published
                datePublished = i['CVE Data']['cveMetadata'].get('datePublished', None)
                
                # Note ID
                if 'references' in i['CVE Data']['containers']['cna'].keys():
                    note_id = re.findall('[2,3]{1}[0-9]{6}', str(i['CVE Data']['containers']['cna']['references'][0]['url']))
                else:
                    note_id = None
                
                row_list = {
                    'cve_id': i['CVE Data']['cveMetadata']['cveId'],
                    'datePublished': datePublished,
                    'dateUpdated': i['CVE Data']['cveMetadata']['dateUpdated'],
                    'descriptions': i['CVE Data']['containers']['cna']['descriptions'][0]['value'],
                    'product_l': i['CVE Data']['containers']['cna']['affected'][0]['product'],
                    'epss_l': epss_l,
                    'percentile': percentile,
                    'priority_l': i['Priority']['Priority'],
                    'cweId': cweId,
                    'note_id': str(note_id)
                }
                dict_list.append(row_list)
            
            data = pd.DataFrame.from_dict(dict_list)
            data.drop_duplicates(subset=['cve_id'], inplace=True)
            
            console.print(f"‚úÖ Registros procesados: {len(data)}")
            return data
            
        except Exception as e:
            console.print(f"‚ùå Error: {e}")
            logger.error(f"Error en dataframeSplotscan: {e}", exc_info=True)
            return pd.DataFrame()
    
    def merge_results(
        self,
        sap_df: pd.DataFrame,
        sploitscan_df: pd.DataFrame,
        prioritizer_file: str,
        year: int
    ) -> pd.DataFrame:
        """Combina todos los resultados"""
        console.print("üîó Combinando resultados...")
        
        try:
            result_df = sap_df.copy()
            
            # Merge SploitScan
            if not sploitscan_df.empty:
                result_df = result_df.merge(sploitscan_df, on=['cve_id'], how='left')
                console.print("‚úÖ SploitScan combinado")
            
            # Merge CVE_Prioritizer
            if os.path.exists(prioritizer_file):
                cp_df = pd.read_csv(prioritizer_file)
                cp_df.drop_duplicates(subset=['cve_id'], inplace=True)
                result_df = result_df.merge(cp_df, on=['cve_id'], how='left')
                console.print("‚úÖ CVE_Prioritizer combinado")
            
            # A√±adir a√±o
            result_df['sap_note_year'] = str(year)
            
            # Renombrar columnas
            result_df.rename(columns={
                'Col0': 'Note#',
                'Col1': 'Title',
                'Col2': 'Priority',
                'Col3': 'CVSS'
            }, inplace=True)
            
            # Orden de columnas
            final_cols = [
                'cve_id', 'datePublished', 'dateUpdated', 'descriptions',
                'product_l', 'epss_l', 'percentile', 'priority_l', 'cweId',
                'note_id', 'Note#', 'Title', 'Priority', 'CVSS',
                'priority', 'epss', 'cvss', 'cvss_version', 'cvss_severity',
                'kev', 'ransomware', 'kev_source', 'cpe', 'vendor',
                'product', 'vector', 'sap_note_year'
            ]
            
            existing_cols = [col for col in final_cols if col in result_df.columns]
            result_df = result_df[existing_cols]
            
            console.print(f"‚úÖ Total registros: {len(result_df)}")
            return result_df
            
        except Exception as e:
            console.print(f"‚ùå Error combinando: {e}")
            logger.error(f"Error en merge: {e}", exc_info=True)
            return sap_df
    
    def save_results(self, df: pd.DataFrame, filename: str) -> str:
        """Guarda resultados finales"""
        output_file = self.output_dir / f"{filename}.csv"
        try:
            df.to_csv(output_file, index=False)
            console.print(f"üíæ Guardado: {output_file}")
            return str(output_file)
        except Exception as e:
            console.print(f"‚ùå Error guardando: {e}")
            return ""
    
    def print_summary(self, df: pd.DataFrame):
        """Imprime resumen"""
        if df.empty:
            return
        
        console.print("\n" + "="*60)
        console.print("üìä RESUMEN DEL AN√ÅLISIS")
        console.print("="*60)
        
        total = len(df)
        cves = len(df[df['cve_id'].notna()])
        
        console.print(f"üìã Total registros: {total}")
        console.print(f"üîç CVE-IDs: {cves}")
        
        if 'Priority' in df.columns:
            console.print(f"\nüìä Distribuci√≥n por prioridad:")
            for priority, count in df['Priority'].value_counts().items():
                pct = (count/total)*100
                console.print(f"   ‚Ä¢ {priority}: {count} ({pct:.1f}%)")


# ==================== CLI COMMANDS ====================

@app.command()
def analyze(
    year: int = typer.Option(None, help="A√±o"),
    month: int = typer.Option(None, help="Mes (1-12)"),
    skip_sploitscan: bool = typer.Option(False, "--skip-sploitscan"),
    skip_prioritizer: bool = typer.Option(False, "--skip-prioritizer"),
    sploitscan_path: str = typer.Option(".", help="Path SploitScan"),
    prioritizer_path: str = typer.Option(".", help="Path CVE_Prioritizer"),
    output_name: str = typer.Option(None, help="Nombre salida"),
    batch_size: int = typer.Option(BATCH_SIZE, help="Tama√±o lote"),
    max_workers: int = typer.Option(MAX_WORKERS, help="Workers concurrentes")
):
    """üöÄ An√°lisis completo SAP CVE (OPTIMIZADO)"""
    
    # Defaults
    year = year or datetime.now().year
    month = month or datetime.now().month
    
    if not (1 <= month <= 12):
        console.print("‚ùå Mes debe ser 1-12")
        raise typer.Exit(1)
    
    # Header
    console.print("="*60)
    console.print("üîí SAP CVE AUTOMATION - OPTIMIZADO")
    console.print("="*60)
    console.print(f"üìÖ Periodo: {month:02d}/{year}")
    console.print(f"üîç SploitScan: {'‚ùå No' if skip_sploitscan else '‚úÖ S√≠'}")
    console.print(f"üìä Prioritizer: {'‚ùå No' if skip_prioritizer else '‚úÖ S√≠'}")
    console.print(f"‚öôÔ∏è Lote: {batch_size} | Workers: {max_workers}")
    console.print("="*60)
    
    automation = SAPCVEAutomation()
    
    # PASO 1: Extraer SAP
    console.print("\n1Ô∏è‚É£ EXTRAYENDO DATOS SAP")
    console.print("-" * 40)
    sap_data = automation.extract_sap_data(year, month)
    
    # PASO 2: Procesar
    console.print("\n2Ô∏è‚É£ PROCESANDO DATOS")
    console.print("-" * 40)
    sap_df, cve_list = automation.process_sap_data(sap_data)
    
    if not cve_list:
        console.print("‚ö†Ô∏è Sin CVEs - solo datos SAP")
        skip_sploitscan = skip_prioritizer = True
    
    # PASO 3: SploitScan
    sploitscan_df = pd.DataFrame()
    if not skip_sploitscan and cve_list:
        console.print("\n3Ô∏è‚É£ SPLOITSCAN")
        console.print("-" * 40)
        
        sploitscan_file = automation.run_sploitscan(
            cve_list,
            sploitscan_path,
            batch_size,
            max_workers
        )
        
        if sploitscan_file:
            source = os.path.join(sploitscan_path, sploitscan_file) if sploitscan_path != "." else sploitscan_file
            dest = automation.output_dir / f"sploitscan_{year}{month:02d}.json"
            try:
                shutil.copy(source, dest)
                sploitscan_df = automation.dataframeSplotscan(str(dest))
            except Exception as e:
                console.print(f"‚ö†Ô∏è Error copiando: {e}")
                if os.path.exists(source):
                    sploitscan_df = automation.dataframeSplotscan(source)
    
    # PASO 4: CVE_Prioritizer
    prioritizer_file = ""
    if not skip_prioritizer and cve_list:
        console.print("\n4Ô∏è‚É£ CVE_PRIORITIZER")
        console.print("-" * 40)
        
        csv_file = f"prioritizer_{year}{month:02d}.csv"
        if automation.run_cve_prioritizer(cve_list, csv_file, prioritizer_path):
            source = os.path.join(prioritizer_path, csv_file) if prioritizer_path != "." else csv_file
            dest = automation.output_dir / csv_file
            try:
                shutil.copy(source, dest)
                prioritizer_file = str(dest)
            except Exception as e:
                console.print(f"‚ö†Ô∏è Error copiando: {e}")
                if os.path.exists(source):
                    prioritizer_file = source
    
    # PASO 5: Combinar
    console.print("\n5Ô∏è‚É£ COMBINANDO")
    console.print("-" * 40)
    final_df = automation.merge_results(sap_df, sploitscan_df, prioritizer_file, year)
    
    # PASO 6: Guardar
    console.print("\n6Ô∏è‚É£ GUARDANDO")
    console.print("-" * 40)
    output_name = output_name or f"sap_cve_{year}{month:02d}"
    output_file = automation.save_results(final_df, output_name)
    
    # Resumen
    automation.print_summary(final_df)
    
    if output_file:
        console.print(f"\n‚úÖ COMPLETADO")
        console.print(f"üìÅ {output_file}")
    else:
        console.print(f"\n‚ö†Ô∏è Completado con advertencias")


@app.command()
def test():
    """üß™ Test herramientas"""
    console.print("üß™ PROBANDO COMANDOS")
    console.print("="*40)
    
    # SploitScan
    console.print("\nüîç SploitScan:")
    try:
        result = subprocess.run(["sploitscan", "--help"], capture_output=True, timeout=5)
        console.print("‚úÖ FUNCIONA" if result.returncode == 0 else "‚ùå ERROR")
    except:
        console.print("‚ùå NO ENCONTRADO")
    
    # CVE_Prioritizer
    console.print("\nüìä CVE_Prioritizer:")
    try:
        result = subprocess.run(["cve_prioritizer", "--help"], capture_output=True, timeout=5)
        console.print("‚úÖ FUNCIONA" if result.returncode == 0 else "‚ùå ERROR")
    except:
        console.print("‚ùå NO ENCONTRADO")


if __name__ == "__main__":
    app()